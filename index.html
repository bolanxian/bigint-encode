<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>BigInt Encoder</title>
  <style>
    body {
      font-size: 16px;
      color: #111;
      padding: 0;
      margin: 0;
      background: #fff;
      min-width: 320px;
    }
    textarea,
    input,
    select {
      resize: none;
      outline: none;
      font-size: 1em;
    }
    .main {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 10px;
      line-height: 1.5em;
      word-wrap: break-word;
    }
    .main .title {
      text-align: center;
    }
    .main .title h1 {
      display: inline-block;
      font-weight: 500;
      font-size: 30px;
      text-align: left;
      line-height: 1.1em;
      margin: 15px 0;
    }
    .main textarea {
      width: 100%;
      height: 150px;
      border: solid 1px #ccc;
      padding: 1%;
      line-height: 140%;
      box-sizing: border-box
    }
    .main textarea:hover {
      border-color: #999;
    }
    .main textarea:focus {
      border-color: #59f;
    }
  </style>
</head>

<body>
  <form id="bigint-encode" class="main" action="about:blank">
    <div class="title">
      <h1>BigInt Encoder</h1>
    </div>
    <textarea name="src"></textarea>
    <div style="margin:10px 0px;">
      <span style="display:inline-block;">
        <label><input type="radio" name="type" value="base20976" checked>Base20976</label>
        <label><input type="radio" name="type" value="base2048Bip39Cn">Base2048-BIP39-cn</label>
        <label><input type="radio" name="type" value="base2048Bip39En">Base2048-BIP39-en</label>
        <label><input type="radio" name="type" value="base58">Base58LE</label>
        <label><input type="radio" name="type" value="切噜LE">切噜LE</label>
      </span>
      <br>
      <input type="submit" value="编码" name="encode">
      <input type="submit" value="解码" name="decodeString">
      <span style="display:inline-block;">
        <label><input type="radio" name="compression" value="null" checked>无压缩</label>
        <label><input type="radio" name="compression" value="deflate-raw">deflate-raw</label>
        <!-- <label><input type="radio" name="compression" value="gzip">gzip</label> -->
        <!-- <label><input type="radio" name="compression" value="deflate">deflate</label> -->
      </span>
    </div>
    <textarea name="dest" readonly=""></textarea>
    <div style="margin:10px 0px;">
      <input type="button" id="copy" value="复制" style="display: inline-block;">
      <span id="copytip"></span>
    </div>
  </form>
  <script src="./bigint-encode.js"></script>
  <script src="./base2048-bip39-cn.js"></script>
  <script src="./base2048-bip39-en.js"></script>
  <script>
    (() => {
      {
        const query='#bigint-encode [name=compression]:not([value=null])'
        for(const radio of document.querySelectorAll(query)){
          try{
            new CompressionStream(radio.value)
          }catch(e){
            radio.disabled=true
          }
        }
      }
      const tip = document.querySelector('#copytip')
      const dest = document.querySelector('#bigint-encode [name=dest]')
      const copy = data => {
        let msg = ''
        try {
          data.focus()
          data.select()
          if (document.execCommand('copy', false, null)) { msg = '已复制！' }
        } catch (e) { msg = '...' }
        tip.innerText = msg
        document.addEventListener("click", e => { tip.innerText = '' }, { capture: !0, once: !0 })
      }
      document.querySelector('#copy').addEventListener('click', e => { copy(dest) })
      const compressor={
        transfer(body,transform){
          ;({body}=new Response(body))
          body=body.pipeThrough(transform)
          return new Response(body)
        },
        async encode(encoder,body,format='gzip'){
          const transform=new CompressionStream(format)
          const buf=await this.transfer(body,transform).arrayBuffer()
          const encoded=encoder.encode(new Uint8Array(buf))
          return encoded
        },
        async decodeString(encoder,encoded,format='gzip'){
          const transform=new DecompressionStream(format)
          const buf=encoder.decode(encoded)
          const decoded=await this.transfer(buf,transform).text()
          return decoded
        }
      }
      window.compressor=compressor
      document.querySelector('#bigint-encode').addEventListener('submit',async(e)=>{
        e.preventDefault()
        e.stopPropagation()
        const { elements: els } = e.target
        let src = els.namedItem('src').value
        try {
          const encoder=BigIntEncoder[els.namedItem('type').value]
          const format=els.namedItem('compression').value
          if(format==='null'){
            src = encoder[e.submitter.name](src)
          }else{
            src = await compressor[e.submitter.name](encoder,src,format)
          }
          tip.innerText = ''
        } catch (err) {
          src = ''
          tip.innerText = e.submitter.value + '失败'
          throw err
        } finally {
          els.namedItem('dest').value = src
        }
      })
    })()
  </script>
</body>

</html>